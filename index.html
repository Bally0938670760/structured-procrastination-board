<!doctype html>
<html lang="zh-Hant">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>çµæ§‹åŒ–æ‹–å»¶ä»»å‹™æ¿</title>
	<meta name="description" content="çµæ§‹åŒ–æ‹–å»¶ä»»å‹™ç®¡ç†å·¥å…·">
	<meta name="theme-color" content="#151a20">
	<link rel="manifest" href="manifest.json">
	<style>
	:root{
		--bg:#0f1216;--panel:#151a20;--panel-2:#1b222b;--text:#e6edf3;--muted:#9aa6b2;--border:#283241;
		--red:#ef4444;--yellow:#f59e0b;--green:#22c55e;--blue:#3b82f6;
	}
	*{box-sizing:border-box} html,body{height:100%}
	body{margin:0;background:linear-gradient(180deg,#0e131a,#0b0f14);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
	.app-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:5}
	h1{margin:0;font-size:18px}
	.actions{display:flex;gap:8px}
	.actions button{background:var(--blue);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:13px}
	.actions button:hover{filter:brightness(1.05)}
	.actions button.secondary{background:var(--panel-2);border:1px solid var(--border)}
	.board{display:grid;grid-template-columns:repeat(4,minmax(240px,1fr));gap:12px;padding:16px;align-items:start}
	.column{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;min-height:200px}
	.column-header{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;border-bottom:1px solid var(--border);background:var(--panel-2);flex-wrap:wrap;gap:8px}
	.column-title{display:flex;gap:8px;align-items:center}
	.column-title .emoji{font-size:18px}
	.column-title h2{margin:0;font-size:14px}
	.column-hint{color:var(--muted);font-size:12px;margin:6px 12px 0 12px}
	.sort-controls{display:flex;gap:6px;margin-left:auto}
	.sort-btn{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:11px;white-space:nowrap}
	.sort-btn:hover{background:var(--panel-2)}
	.sort-btn.active{background:var(--blue);border-color:var(--blue);color:#fff}
	.task-list{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:140px}
	.task{background:#0e1622;border:1px solid var(--border);border-radius:10px;padding:10px;gap:8px;display:flex;flex-direction:column}
	.task[dragging]{opacity:.6}
	.task-top{display:flex;gap:8px;align-items:center}
	.task-title{flex:1;background:transparent;border:0;border-bottom:1px dashed var(--border);color:var(--text);padding:4px 2px;outline:none}
	.task-row{display:grid;grid-template-columns:64px 1fr;gap:8px;align-items:center}
	.task-row label{color:var(--muted);font-size:12px}
	.task-status,.task-priority{width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px}
	.priority-dot{width:10px;height:10px;border-radius:50%;background:var(--yellow);box-shadow:0 0 0 2px #0003 inset}
	.subtasks{display:flex;flex-direction:column;gap:6px}
	.subtasks-header{display:flex;align-items:center;justify-content:space-between}
	.subtasks-header label{color:var(--muted);font-size:12px}
	.add-subtask{background:#263244;color:#cfe1ff;border:1px dashed #37517a;border-radius:6px;padding:2px 8px;cursor:pointer;font-size:12px}
	.subtasks-list{display:flex;flex-direction:column;gap:6px}
	.subtask{display:flex;align-items:center;gap:8px;background:#0b1320;border:1px solid var(--border);border-radius:8px;padding:6px 8px;flex-wrap:wrap}
	.subtask input[type="text"]{flex:1;min-width:100px;background:transparent;border:0;border-bottom:1px dashed var(--border);color:var(--text);outline:none;padding:2px}
	.subtask input[type="checkbox"]{cursor:pointer}
	.subtask .time-display{min-width:78px;font-family:monospace;background:#131d2b;border:1px solid #263244;border-radius:6px;padding:4px 6px;text-align:center;font-size:12px;color:#b8d4ff}
	.subtask .time-btn{background:#223049;color:#d6e4ff;border:1px solid #32476b;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;white-space:nowrap}
	.subtask .time-btn.stop{background:#4c1f28;border-color:#6c2c39;color:#ffd4d4}
	.subtask .time-btn:disabled{opacity:.5;cursor:default}
	.subtask .remove-sub{background:transparent;border:0;color:#9fb4ff;cursor:pointer;padding:4px;font-size:14px}
	.task-note{width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px;resize:vertical}
	.task-footer{display:flex;justify-content:flex-end;gap:8px}
	.delete-task{background:#221416;border:1px solid #51222a;color:#ffc3c3;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:12px}
	.delete-task:hover{filter:brightness(1.08)}
	.add-task-btn{background:#1b2431;border:1px solid var(--border);color:#dbe7ff;border-radius:8px;padding:6px 12px;cursor:pointer;font-size:12px;margin:8px 12px}
	.add-task-btn:hover{background:var(--panel-2)}
	.add-form{margin:8px 12px 12px 12px;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#0c1219;display:grid;gap:8px}
	.add-form input,.add-form textarea,.add-form select{width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px}
	.add-form .actions{display:flex;gap:8px}
	.add-form button{cursor:pointer;border-radius:8px;border:1px solid var(--border);background:#1b2431;color:#dbe7ff;padding:6px 10px}
	.add-form button.primary{background:var(--blue);color:#fff;border:0}
	@media (max-width:1200px){.board{grid-template-columns:repeat(3,minmax(240px,1fr))}}
	@media (max-width:800px){.board{grid-template-columns:repeat(2,minmax(240px,1fr))}}
	@media (max-width:560px){
		.board{grid-template-columns:1fr}
		.app-header{flex-direction:column;align-items:flex-start;gap:8px}
		.actions{width:100%;justify-content:space-between}
		.sort-controls{width:100%;justify-content:flex-end}
	}
	</style>
</head>
<body>
	<header class="app-header">
		<h1>ã€Šçµæ§‹åŒ–æ‹–å»¶ä»»å‹™æ¿ã€‹</h1>
		<div class="actions">
			<button id="addTaskBtn" class="secondary">ï¼‹ æ–°å¢ä»»å‹™</button>
			<button id="resetBtn" title="æ¸…é™¤æœ¬åœ°è³‡æ–™ä¸¦è¼‰å…¥ç¯„ä¾‹">é‡ç½®ç‚ºç¯„ä¾‹</button>
		</div>
	</header>

	<main id="board" class="board"></main>

	<template id="task-template">
		<div class="task" draggable="true">
			<div class="task-top">
				<div class="priority-dot" title="å„ªå…ˆåº¦"></div>
				<input class="task-title" placeholder="ä»»å‹™åç¨±">
			</div>

			<div class="task-row">
				<label>ç‹€æ…‹</label>
				<select class="task-status">
					<option>â³ å°šæœªé–‹å§‹</option>
					<option>ğŸ”„ é€²è¡Œä¸­</option>
					<option>âœ… å®Œæˆ</option>
				</select>
			</div>

			<div class="task-row">
				<label>å„ªå…ˆåº¦</label>
				<select class="task-priority">
					<option>ğŸ”´ é«˜å„ªå…ˆï¼ˆç·Šæ€¥ & é‡è¦ï¼‰</option>
					<option>ğŸŸ¡ ä¸­å„ªå…ˆï¼ˆæ¬¡è¦ï¼‰</option>
					<option>ğŸŸ¢ ä½å„ªå…ˆï¼ˆè¼•é¬†å°äº‹ï¼‰</option>
				</select>
			</div>

			<div class="subtasks">
				<div class="subtasks-header">
					<label>å­æ­¥é©Ÿæ¸…å–®</label>
					<button class="add-subtask" title="æ–°å¢å­æ­¥é©Ÿ">ï¼‹</button>
				</div>
				<div class="subtasks-list"></div>
			</div>

			<div class="task-row">
				<label>å‚™è¨»</label>
				<textarea class="task-note" rows="2" placeholder="è£œå……èªªæ˜..."></textarea>
			</div>

			<div class="task-footer">
				<button class="delete-task">åˆªé™¤</button>
			</div>
		</div>
	</template>

	<div id="addTaskModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center">
		<div style="background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:20px;max-width:400px;width:90%;max-height:90vh;overflow-y:auto">
			<h3 style="margin-top:0">æ–°å¢ä»»å‹™</h3>
			<div style="display:grid;gap:12px">
				<div>
					<label style="display:block;margin-bottom:4px;color:var(--muted);font-size:12px">é¡åˆ¥</label>
					<select id="modal-category" style="width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px"></select>
				</div>
				<div>
					<label style="display:block;margin-bottom:4px;color:var(--muted);font-size:12px">ä»»å‹™åç¨±</label>
					<input id="modal-title" type="text" placeholder="ä»»å‹™åç¨±" style="width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px">
				</div>
				<div>
					<label style="display:block;margin-bottom:4px;color:var(--muted);font-size:12px">ç‹€æ…‹</label>
					<select id="modal-status" style="width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px"></select>
				</div>
				<div>
					<label style="display:block;margin-bottom:4px;color:var(--muted);font-size:12px">å„ªå…ˆåº¦</label>
					<select id="modal-priority" style="width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px"></select>
				</div>
				<div>
					<label style="display:block;margin-bottom:4px;color:var(--muted);font-size:12px">å‚™è¨»</label>
					<textarea id="modal-note" rows="3" placeholder="å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰" style="width:100%;background:#0c131d;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px;resize:vertical"></textarea>
				</div>
				<div style="display:flex;gap:8px;justify-content:flex-end">
					<button id="modal-cancel" style="background:var(--panel-2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 16px;cursor:pointer">å–æ¶ˆ</button>
					<button id="modal-submit" style="background:var(--blue);color:#fff;border:0;border-radius:8px;padding:8px 16px;cursor:pointer">æ–°å¢</button>
				</div>
			</div>
		</div>
	</div>

	<script>
	const CATEGORIES = [
		{ key:'pressure',  emoji:'ğŸ§¨', title:'é«˜å£“ç£å¯Ÿä»»å‹™', hint:'æ”¾åœ¨æ¸…å–®æœ€ä¸Šé¢ï¼Œæˆç‚ºå¿ƒç†"å£“åŠ›æº"' },
		{ key:'simple',    emoji:'ğŸ› ', title:'è¼ƒç°¡ä»»å‹™',     hint:'è¶è‘—ã€Œé€ƒé¿ã€å¤§ä»»å‹™æ™‚å®Œæˆï¼Œå¯ç”¢ç”Ÿæˆå°±æ„Ÿ' },
		{ key:'support',   emoji:'ğŸ“š', title:'æ”¯æ´ä»»å‹™',     hint:'å´é¢æ¨é€²ä¸»ä»»å‹™' },
		{ key:'fuzzy',     emoji:'â˜ï¸', title:'æ¨¡ç³Šä»»å‹™',     hint:'æ‹–å»¶æ™‚ç•¶å‚™æ¡ˆã€ä½å£“åŸ·è¡Œ' },
	];
	const STATUS = ['â³ å°šæœªé–‹å§‹','ğŸ”„ é€²è¡Œä¸­','âœ… å®Œæˆ'];
	const PRIORITY = ['ğŸ”´ é«˜å„ªå…ˆï¼ˆç·Šæ€¥ & é‡è¦ï¼‰','ğŸŸ¡ ä¸­å„ªå…ˆï¼ˆæ¬¡è¦ï¼‰','ğŸŸ¢ ä½å„ªå…ˆï¼ˆè¼•é¬†å°äº‹ï¼‰'];
	const LS_KEY = 'structured-procrastination-board.v1';
	const SORT_KEY = 'task-sort-mode.v1';

	// è¨ˆæ™‚å™¨ç®¡ç†
	const activeTimers = new Map();
	const taskElements = new Map(); // å„²å­˜ä»»å‹™ DOM å…ƒç´ ï¼Œé¿å…é‡æ–°æ¸²æŸ“æ™‚ä¸Ÿå¤±ç‹€æ…‹

	// æ’åºæ¨¡å¼ï¼š'manual' | 'priority-high' | 'priority-low'
	let sortModes = {};
	try{
		const saved = localStorage.getItem(SORT_KEY);
		if(saved) sortModes = JSON.parse(saved);
	}catch{}

	function formatDuration(ms){
		const totalSeconds = Math.floor(ms / 1000);
		const s = totalSeconds % 60;
		const m = Math.floor(totalSeconds / 60) % 60;
		const h = Math.floor(totalSeconds / 3600);
		return [h,m,s].map(v=>String(v).padStart(2,'0')).join(':');
	}

	function currentElapsed(st){
		if(st.running && st.startedAt){
			return st.elapsedMs + (Date.now() - st.startedAt);
		}
		return st.elapsedMs;
	}

	function clearTimerInterval(id){
		const handle = activeTimers.get(id);
		if(handle){
			clearInterval(handle);
			activeTimers.delete(id);
		}
	}

	function startSubtaskTimer(task, st, display, startBtn, stopBtn){
		if(st.running) return;
		st.running = true;
		st.startedAt = Date.now();
		persist();
		const update = ()=>{ display.textContent = formatDuration(currentElapsed(st)); };
		update();
		clearTimerInterval(st.id);
		const handle = setInterval(update, 1000);
		activeTimers.set(st.id, handle);
		startBtn.disabled = true;
		stopBtn.disabled = false;
	}

	function stopSubtaskTimer(st, display, startBtn, stopBtn){
		if(!st.running) return;
		const now = Date.now();
		st.elapsedMs += now - (st.startedAt ?? now);
		st.running = false;
		st.startedAt = null;
		clearTimerInterval(st.id);
		display.textContent = formatDuration(st.elapsedMs);
		startBtn.disabled = false;
		stopBtn.disabled = true;
		persist();
	}

	function getPriorityValue(priority){
		if(priority.startsWith('ğŸ”´')) return 3;
		if(priority.startsWith('ğŸŸ¡')) return 2;
		if(priority.startsWith('ğŸŸ¢')) return 1;
		return 0;
	}

	function seedData(){
		return [
			{
				id: crypto.randomUUID(),
				category:'pressure',
				title:'ææ¡ˆç°¡å ±',
				status:'â³ å°šæœªé–‹å§‹',
				priority:'ğŸ”´ é«˜å„ªå…ˆï¼ˆç·Šæ€¥ & é‡è¦ï¼‰',
				note:'æ”¾åœ¨æœ€ä¸Šé¢ï¼Œå½¢æˆå¿ƒç†å£“åŠ›ç‰†',
				subtasks:[
					{ id:crypto.randomUUID(), text:'æ”¶è³‡æ–™', done:false, elapsedMs:0, running:false, startedAt:null },
					{ id:crypto.randomUUID(), text:'æ“¬å¤§ç¶±', done:false, elapsedMs:0, running:false, startedAt:null },
				],
				order:0
			},
			{
				id: crypto.randomUUID(),
				category:'simple',
				title:'æ•´ç†æ¡Œé¢ï¼ˆæ•´ç†ææ¡ˆè³‡æ–™å¤¾ï¼‰',
				status:'ğŸ”„ é€²è¡Œä¸­',
				priority:'ğŸŸ¡ ä¸­å„ªå…ˆï¼ˆæ¬¡è¦ï¼‰',
				note:'é€ƒé¿ä¸»ä»»å‹™æ™‚çš„æ›¿ä»£å“',
				subtasks:[
					{ id:crypto.randomUUID(), text:'åˆ†é¡ç­†', done:false, elapsedMs:0, running:false, startedAt:null },
					{ id:crypto.randomUUID(), text:'æ“¦è¢å¹•', done:false, elapsedMs:0, running:false, startedAt:null },
				],
				order:0
			},
			{
				id: crypto.randomUUID(),
				category:'support',
				title:'æ‰¾å…©ä»½åƒè€ƒè³‡æ–™',
				status:'â³ å°šæœªé–‹å§‹',
				priority:'ğŸŸ¡ ä¸­å„ªå…ˆï¼ˆæ¬¡è¦ï¼‰',
				note:'',
				subtasks:[
					{ id:crypto.randomUUID(), text:'æ‰¾è«–æ–‡', done:false, elapsedMs:0, running:false, startedAt:null },
					{ id:crypto.randomUUID(), text:'æ•´ç†æ¨™é¡Œæ‘˜è¦', done:false, elapsedMs:0, running:false, startedAt:null },
				],
				order:0
			},
			{
				id: crypto.randomUUID(),
				category:'fuzzy',
				title:'æ§‹æ€æ–¹å‘ï¼ˆæ€è€ƒä¸‹ä¸€æ­¥è¨ˆåŠƒï¼‰',
				status:'âœ… å®Œæˆ',
				priority:'ğŸŸ¡ ä¸­å„ªå…ˆï¼ˆæ¬¡è¦ï¼‰',
				note:'',
				subtasks:[
					{ id:crypto.randomUUID(), text:'åˆ—å‡ºé¸é …', done:true, elapsedMs:0, running:false, startedAt:null },
					{ id:crypto.randomUUID(), text:'é æƒ³æƒ…å¢ƒ', done:true, elapsedMs:0, running:false, startedAt:null },
				],
				order:0
			},
		];
	}

	function normalizeTasks(list){
		return list.map(task=>{
			if(task.category === 'simple1' || task.category === 'simple2'){
				task.category = 'simple';
			}
			// ç¢ºä¿æ¯å€‹å­æ­¥é©Ÿéƒ½æœ‰å®Œæ•´çš„è¨ˆæ™‚æ¬„ä½
			task.subtasks = (task.subtasks||[]).map(st=>({
				id: st.id ?? crypto.randomUUID(),
				text: st.text ?? '',
				done: !!st.done,
				elapsedMs: Number.isFinite(st.elapsedMs) ? st.elapsedMs : 0,
				running: !!st.running,
				startedAt: typeof st.startedAt === 'number' ? st.startedAt : null
			}));
			return task;
		});
	}

	const store = {
		load(){
			try{
				const raw = localStorage.getItem(LS_KEY);
				if(!raw) return seedData();
				const parsed = JSON.parse(raw);
				return Array.isArray(parsed) ? parsed : seedData();
			}catch{ return seedData(); }
		},
		save(data){ 
			localStorage.setItem(LS_KEY, JSON.stringify(normalizeTasks(data))); 
		}
	};

	let tasks = normalizeTasks(store.load());

	const el = {
		board: document.getElementById('board'),
		taskTpl: document.getElementById('task-template'),
		resetBtn: document.getElementById('resetBtn'),
		addTaskBtn: document.getElementById('addTaskBtn'),
		modal: document.getElementById('addTaskModal'),
		modalCategory: document.getElementById('modal-category'),
		modalTitle: document.getElementById('modal-title'),
		modalStatus: document.getElementById('modal-status'),
		modalPriority: document.getElementById('modal-priority'),
		modalNote: document.getElementById('modal-note'),
		modalSubmit: document.getElementById('modal-submit'),
		modalCancel: document.getElementById('modal-cancel'),
	};

	function priorityColor(p){
		const css = getComputedStyle(document.documentElement);
		if(p.startsWith('ğŸ”´')) return css.getPropertyValue('--red');
		if(p.startsWith('ğŸŸ¢')) return css.getPropertyValue('--green');
		return css.getPropertyValue('--yellow');
	}

	function saveSortMode(category, mode){
		sortModes[category] = mode;
		try{
			localStorage.setItem(SORT_KEY, JSON.stringify(sortModes));
		}catch{}
	}

	function getSortedTasks(catKey, taskList){
		const mode = sortModes[catKey] || 'manual';
		if(mode === 'manual'){
			return [...taskList].sort((a,b)=>a.order - b.order || a.title.localeCompare(b.title,'zh-Hant'));
		}else if(mode === 'priority-high'){
			return [...taskList].sort((a,b)=>{
				const prioDiff = getPriorityValue(b.priority) - getPriorityValue(a.priority);
				if(prioDiff !== 0) return prioDiff;
				return a.order - b.order || a.title.localeCompare(b.title,'zh-Hant');
			});
		}else if(mode === 'priority-low'){
			return [...taskList].sort((a,b)=>{
				const prioDiff = getPriorityValue(a.priority) - getPriorityValue(b.priority);
				if(prioDiff !== 0) return prioDiff;
				return a.order - b.order || a.title.localeCompare(b.title,'zh-Hant');
			});
		}
		return taskList;
	}

	function render(){
		el.board.innerHTML = '';
		taskElements.clear();
		
		CATEGORIES.forEach(cat=>{
			const col = document.createElement('section');
			col.className='column';
			col.dataset.category = cat.key;

			const header = document.createElement('div');
			header.className='column-header';
			header.innerHTML = `
				<div class="column-title">
					<span class="emoji">${cat.emoji}</span>
					<h2>${cat.title}</h2>
				</div>
				<div class="sort-controls">
					<button class="sort-btn ${(sortModes[cat.key] || 'manual') === 'manual' ? 'active' : ''}" data-mode="manual" data-cat="${cat.key}" title="æ‰‹å‹•æ’åº">æ‰‹å‹•</button>
					<button class="sort-btn ${sortModes[cat.key] === 'priority-high' ? 'active' : ''}" data-mode="priority-high" data-cat="${cat.key}" title="å„ªå…ˆç´šï¼šé«˜â†’ä½">é«˜â†’ä½</button>
					<button class="sort-btn ${sortModes[cat.key] === 'priority-low' ? 'active' : ''}" data-mode="priority-low" data-cat="${cat.key}" title="å„ªå…ˆç´šï¼šä½â†’é«˜">ä½â†’é«˜</button>
				</div>
			`;

			// æ’åºæŒ‰éˆ•äº‹ä»¶
			header.querySelectorAll('.sort-btn').forEach(btn=>{
				btn.addEventListener('click', ()=>{
					const mode = btn.dataset.mode;
					const catKey = btn.dataset.cat;
					saveSortMode(catKey, mode);
					// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
					header.querySelectorAll('.sort-btn').forEach(b=>b.classList.remove('active'));
					btn.classList.add('active');
					// é‡æ–°æ¸²æŸ“è©²æ¬„ä½
					const list = col.querySelector('.task-list');
					if(list){
						list.innerHTML = '';
						getSortedTasks(catKey, tasks.filter(t=>t.category===catKey)).forEach(t=>{
							list.appendChild(renderTask(t));
						});
					}
				});
			});

			col.appendChild(header);

			if(cat.hint){
				const hint = document.createElement('div');
				hint.className='column-hint';
				hint.textContent = cat.hint;
				col.appendChild(hint);
			}

			const list = document.createElement('div');
			list.className='task-list';
			list.addEventListener('dragover', onListDragOver);
			list.addEventListener('drop', onListDrop);

			const categoryTasks = tasks.filter(t=>t.category===cat.key);
			getSortedTasks(cat.key, categoryTasks).forEach(t=>{
				const taskEl = renderTask(t);
				list.appendChild(taskEl);
				taskElements.set(t.id, taskEl);
			});

			col.appendChild(list);
			el.board.appendChild(col);
		});
	}

	function getTasksByCategory(catKey){
		return tasks.filter(t=>t.category===catKey);
	}

	function updateTaskInDOM(task){
		const taskEl = taskElements.get(task.id);
		if(!taskEl) return;

		// æ›´æ–°å„ªå…ˆåº¦é¡è‰²
		const dot = taskEl.querySelector('.priority-dot');
		if(dot) dot.style.background = priorityColor(task.priority);

		// æ›´æ–°ç‹€æ…‹å’Œå„ªå…ˆåº¦é¸æ“‡å™¨
		const statusSel = taskEl.querySelector('.task-status');
		if(statusSel && statusSel.value !== task.status) statusSel.value = task.status;
		const prioSel = taskEl.querySelector('.task-priority');
		if(prioSel && prioSel.value !== task.priority) prioSel.value = task.priority;

		// æ›´æ–°æ¨™é¡Œå’Œå‚™è¨»
		const title = taskEl.querySelector('.task-title');
		if(title && title.value !== task.title) title.value = task.title;
		const note = taskEl.querySelector('.task-note');
		if(note && note.value !== task.note) note.value = task.note || '';

		// æ›´æ–°å­æ­¥é©Ÿåˆ—è¡¨ï¼ˆåªæ›´æ–°å¿…è¦çš„éƒ¨åˆ†ï¼Œé¿å…é‡ç½®ç‹€æ…‹ï¼‰
		const subtasksList = taskEl.querySelector('.subtasks-list');
		if(subtasksList){
			const existingSubtasks = Array.from(subtasksList.children);
			const currentIds = new Set((task.subtasks||[]).map(st=>st.id));

			// ç§»é™¤ä¸å­˜åœ¨çš„å­æ­¥é©Ÿ
			existingSubtasks.forEach(el=>{
				const subId = el.dataset.subId;
				if(subId && !currentIds.has(subId)){
					const st = findSubtaskById(task, subId);
					if(st){
						stopSubtaskTimer(st, 
							el.querySelector('.time-display'),
							el.querySelector('.time-btn.start'),
							el.querySelector('.time-btn.stop')
						);
					}
					el.remove();
				}
			});

			// æ·»åŠ æ–°çš„å­æ­¥é©Ÿæˆ–æ›´æ–°ç¾æœ‰çš„
			(task.subtasks||[]).forEach(st=>{
				const existing = subtasksList.querySelector(`[data-sub-id="${st.id}"]`);
				if(existing){
					// æ›´æ–°ç¾æœ‰å­æ­¥é©Ÿçš„æ–‡å­—å’Œç‹€æ…‹ï¼Œä½†ä¿ç•™è¨ˆæ™‚å™¨ç‹€æ…‹
					const txt = existing.querySelector('input[type="text"]');
					if(txt && txt.value !== st.text) txt.value = st.text;
					const chk = existing.querySelector('input[type="checkbox"]');
					if(chk && chk.checked !== st.done) chk.checked = st.done;
				}else{
					// æ·»åŠ æ–°å­æ­¥é©Ÿ
					subtasksList.appendChild(renderSubtask(task, st));
				}
			});
		}
	}

	function findSubtaskById(task, subId){
		return (task.subtasks||[]).find(st=>st.id === subId);
	}

	function renderTask(task){
		// æª¢æŸ¥æ˜¯å¦å·²æœ‰ DOM å…ƒç´ ï¼Œå¦‚æœæœ‰ä¸”ä»»å‹™æ•¸æ“šæœªè®Šï¼Œå‰‡é‡ç”¨
		let node = taskElements.get(task.id);
		if(node && node.parentElement){
			updateTaskInDOM(task);
			return node;
		}

		node = el.taskTpl.content.firstElementChild.cloneNode(true);
		node.dataset.id = task.id;

		const title = node.querySelector('.task-title');
		title.value = task.title;
		title.addEventListener('input', e=>{
			task.title = e.target.value.trim();
			persist();
		});

		const statusSel = node.querySelector('.task-status');
		statusSel.value = task.status;
		statusSel.addEventListener('change', e=>{
			task.status = e.target.value;
			persist();
		});

		const prioSel = node.querySelector('.task-priority');
		prioSel.value = task.priority;
		prioSel.addEventListener('change', e=>{
			task.priority = e.target.value;
			node.querySelector('.priority-dot').style.background = priorityColor(task.priority);
			persist();
			// å¦‚æœè©²æ¬„ä½ä½¿ç”¨å„ªå…ˆç´šæ’åºï¼Œé‡æ–°æ¸²æŸ“
			const cat = node.closest('.column')?.dataset.category;
			if(cat && (sortModes[cat] === 'priority-high' || sortModes[cat] === 'priority-low')){
				render();
			}
		});
		node.querySelector('.priority-dot').style.background = priorityColor(task.priority);

		const note = node.querySelector('.task-note');
		note.value = task.note || '';
		note.addEventListener('input', e=>{
			task.note = e.target.value;
			persist();
		});

		// Subtasks
		const list = node.querySelector('.subtasks-list');
		(task.subtasks||[]).forEach(st=> list.appendChild(renderSubtask(task, st)));
		node.querySelector('.add-subtask').addEventListener('click', ()=>{
			const st = { id:crypto.randomUUID(), text:'', done:false, elapsedMs:0, running:false, startedAt:null };
			if(!task.subtasks) task.subtasks = [];
			task.subtasks.push(st);
			list.appendChild(renderSubtask(task, st));
			persist();
		});

		// Delete
		node.querySelector('.delete-task').addEventListener('click', ()=>{
			if(confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')){
				// åœæ­¢æ‰€æœ‰å­æ­¥é©Ÿçš„è¨ˆæ™‚å™¨
				(task.subtasks||[]).forEach(st=>{
					clearTimerInterval(st.id);
				});
				tasks = tasks.filter(t=>t.id!==task.id);
				taskElements.delete(task.id);
				persist();
				render();
			}
		});

		// DnD
		node.addEventListener('dragstart', onTaskDragStart);
		node.addEventListener('dragend', onTaskDragEnd);

		return node;
	}

	function renderSubtask(task, st){
		const row = document.createElement('div');
		row.className='subtask';
		row.dataset.subId = st.id;

		const chk = document.createElement('input');
		chk.type='checkbox';
		chk.checked = !!st.done;
		chk.addEventListener('change', ()=>{
			st.done = chk.checked;
			persist();
		});

		const txt = document.createElement('input');
		txt.type='text';
		txt.placeholder='å­æ­¥é©Ÿ...';
		txt.value = st.text || '';
		txt.addEventListener('input', ()=>{
			st.text = txt.value;
			persist();
		});

		const display = document.createElement('span');
		display.className='time-display';
		display.textContent = formatDuration(currentElapsed(st));

		const startBtn = document.createElement('button');
		startBtn.className='time-btn start';
		startBtn.textContent='é–‹å§‹';
		startBtn.addEventListener('click', ()=>{
			startSubtaskTimer(task, st, display, startBtn, stopBtn);
		});

		const stopBtn = document.createElement('button');
		stopBtn.className='time-btn stop';
		stopBtn.textContent='åœæ­¢';
		stopBtn.addEventListener('click', ()=>{
			stopSubtaskTimer(st, display, startBtn, stopBtn);
		});

		const rm = document.createElement('button');
		rm.className='remove-sub';
		rm.textContent='âœ•';
		rm.title='åˆªé™¤æ­¤å­æ­¥é©Ÿ';
		rm.addEventListener('click', ()=>{
			if(confirm('åˆªé™¤é€™å€‹å­æ­¥é©Ÿï¼Ÿ')){
				stopSubtaskTimer(st, display, startBtn, stopBtn);
				// ç›´æ¥å¾ä»»å‹™çš„å­æ­¥é©Ÿé™£åˆ—ä¸­ç§»é™¤ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹ä»»å‹™
				task.subtasks = task.subtasks.filter(s=>s.id!==st.id);
				row.remove();
				persist();
			}
		});

		if(st.running){
			startBtn.disabled = true;
			stopBtn.disabled = false;
			startSubtaskTimer(task, st, display, startBtn, stopBtn);
		}else{
			startBtn.disabled = false;
			stopBtn.disabled = true;
		}

		row.appendChild(chk);
		row.appendChild(txt);
		row.appendChild(display);
		row.appendChild(startBtn);
		row.appendChild(stopBtn);
		row.appendChild(rm);
		return row;
	}

	/* ---------- Modal for Adding Tasks ---------- */
	function showAddTaskModal(){
		// å¡«å……é¡åˆ¥é¸é …
		el.modalCategory.innerHTML = '';
		CATEGORIES.forEach(cat=>{
			const opt = document.createElement('option');
			opt.value = cat.key;
			opt.textContent = `${cat.emoji} ${cat.title}`;
			el.modalCategory.appendChild(opt);
		});

		// å¡«å……ç‹€æ…‹é¸é …
		el.modalStatus.innerHTML = '';
		STATUS.forEach(s=>{
			const opt = document.createElement('option');
			opt.textContent = s;
			el.modalStatus.appendChild(opt);
		});

		// å¡«å……å„ªå…ˆåº¦é¸é …
		el.modalPriority.innerHTML = '';
		PRIORITY.forEach(p=>{
			const opt = document.createElement('option');
			opt.textContent = p;
			el.modalPriority.appendChild(opt);
		});

		// é‡ç½®è¡¨å–®
		el.modalTitle.value = '';
		el.modalNote.value = '';
		el.modalCategory.selectedIndex = 0;
		el.modalStatus.selectedIndex = 0;
		el.modalPriority.selectedIndex = 0;

		el.modal.style.display = 'flex';
	}

	function hideAddTaskModal(){
		el.modal.style.display = 'none';
	}

	el.addTaskBtn.addEventListener('click', showAddTaskModal);
	el.modalCancel.addEventListener('click', hideAddTaskModal);
	el.modalSubmit.addEventListener('click', ()=>{
		const title = el.modalTitle.value.trim();
		if(!title){
			alert('è«‹è¼¸å…¥ä»»å‹™åç¨±');
			return;
		}
		const category = el.modalCategory.value;
		const t = {
			id: crypto.randomUUID(),
			category,
			title,
			status: el.modalStatus.value,
			priority: el.modalPriority.value,
			note: el.modalNote.value,
			subtasks: [],
			order: (getTasksByCategory(category).length > 0 ? Math.max(...getTasksByCategory(category).map(t=>t.order)) + 1 : 0)
		};
		tasks.push(t);
		persist();
		hideAddTaskModal();
		render();
	});

	el.modal.addEventListener('click', (e)=>{
		if(e.target === el.modal){
			hideAddTaskModal();
		}
	});

	/* ---------- Drag & Drop ---------- */
	let dragCtx = { id:null };

	function onTaskDragStart(e){
		const id = e.currentTarget.dataset.id;
		dragCtx.id = id;
		e.dataTransfer.effectAllowed = 'move';
		e.dataTransfer.setData('text/plain', id);
		e.currentTarget.setAttribute('dragging','');
	}

	function onTaskDragEnd(e){
		e.currentTarget.removeAttribute('dragging');
		dragCtx.id = null;
	}

	function onListDragOver(e){
		e.preventDefault();
		const list = e.currentTarget;
		const after = getDragAfterElement(list, e.clientY);
		const dragging = document.querySelector('.task[dragging]');
		if(!dragging) return;
		if(after == null){
			list.appendChild(dragging);
		}else{
			list.insertBefore(dragging, after);
		}
	}

	function onListDrop(e){
		e.preventDefault();
		const list = e.currentTarget;
		const col = list.closest('.column');
		const category = col.dataset.category;
		const orderMap = Array.from(list.querySelectorAll('.task')).map((node, idx)=>({
			id: node.dataset.id,
			order: idx
		}));

		// Update task positions and categories
		orderMap.forEach(({id, order})=>{
			const t = tasks.find(x=>x.id===id);
			if(t){
				t.order = order;
				t.category = category;
			}
		});
		persist();
		
		// å¦‚æœè©²æ¬„ä½ä½¿ç”¨å„ªå…ˆç´šæ’åºï¼Œé‡æ–°æ¸²æŸ“ä»¥æ‡‰ç”¨æ’åº
		const mode = sortModes[category];
		if(mode === 'priority-high' || mode === 'priority-low'){
			render();
		}
	}

	function getDragAfterElement(container, y){
		const items = [...container.querySelectorAll('.task:not([dragging])')];
		return items.reduce((closest, child)=>{
			const box = child.getBoundingClientRect();
			const offset = y - box.top - box.height/2;
			if(offset < 0 && offset > closest.offset){
				return { offset, element: child };
			}else{
				return closest;
			}
		},{ offset: Number.NEGATIVE_INFINITY, element: null }).element;
	}

	/* ---------- Persistence & Init ---------- */
	function persist(){
		store.save(tasks);
	}

	function init(){
		el.resetBtn.addEventListener('click', ()=>{
			if(confirm('å°‡æ¸…é™¤ç›®å‰è³‡æ–™ä¸¦è¼‰å…¥ç¯„ä¾‹ï¼Œç¢ºå®šï¼Ÿ')){
				// åœæ­¢æ‰€æœ‰è¨ˆæ™‚å™¨
				[...activeTimers.values()].forEach(handle=>clearInterval(handle));
				activeTimers.clear();
				taskElements.clear();
				tasks = seedData();
				persist();
				render();
			}
		});

		window.addEventListener('beforeunload', ()=>{
			[...activeTimers.values()].forEach(handle=>clearInterval(handle));
			activeTimers.clear();
		});

		render();
	}

	document.addEventListener('DOMContentLoaded', init);
	</script>
</body>
</html>
